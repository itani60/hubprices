<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | CompareHub</title>
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/amazon-cognito-identity-js/6.3.3/aws-cognito-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.3/dist/amazon-cognito-identity.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <img src="https://comparehub-smartphone-images.s3.af-south-1.amazonaws.com/IMG_20250625_174144.jpg" alt="CompareHubPrices" class="logo-image">
                </a>
            </div>
            <div class="search-container">
                <form id="search-form" onsubmit="performSearch(event)">
                    <input type="text" name="q" class="search-input" placeholder="What are you shopping for?" id="searchInput">
                    <button type="submit" class="search-button"><i class="fas fa-search"></i></button>
                </form>
                <div class="search-suggestions" id="searchSuggestions">
                    <div class="suggestions-header">
                        <span class="all-results">All</span>
                        <span class="search-query" id="searchQuery">results</span>
                    </div>
                    <div class="suggestions-grid" id="suggestionsGrid"></div>
                </div>
            </div>
        </div>
        <nav class="category-nav">
            <a href="best-deals.html" class="active"><i class=""></i> Best deals</a>
            <a href="#new-arrivals"><i class=""></i> New Arrivals</a>
            <a href="#wishlist" id="wishlist-link"><i class="fas fa-heart"></i> Wishlist</a>
        </nav>
    </header>

    <div class="main-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-login" id="sidebarLogin"></div>
            <div class="sidebar-search">
                <input type="text" placeholder="Search categories..." id="sidebarSearchInput">
            </div>
            <div class="sidebar-header">
                <h3>Browse Categories</h3>
                <button class="close-sidebar" onclick="closeSidebar()">&times;</button>
            </div>
            <div class="menu-content">
                <!-- [SIDEBAR MENU, UNCHANGED FROM YOUR INPUT, PASTE FULL BLOCK HERE FOR YOUR FINAL USAGE] -->
                <ul class="menu-items">
                    <!-- ... all your <li class="item"> ... structure ... -->
                    <!-- [PASTE YOUR PROVIDED SIDEBAR MENU CONTENT HERE] -->
                    <!-- ... content omitted for brevity ... -->
                </ul>
            </div>
            <div class="sidebar-footer">
                <div class="cookie-notice">
                    <p>This website uses cookies to provide you with the best experience.</p>
                    <button class="accept-cookies" onclick="acceptCookies()">Accept</button>
                </div>
            </div>
        </nav>
        
        <main class="content">
            <div class="profile-container">
                <!-- Profile Sidebar -->
                <div class="profile-sidebar">
                    <div class="profile-avatar">
                        <div class="avatar-image" id="avatarInitials">
                            JD
                            <button class="avatar-upload">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <div class="profile-name" id="profileName"></div>
                        <div class="profile-email" id="profileEmail"></div>
                    </div>
                    <ul class="profile-nav">
                        <li><a href="#" class="nav-link active" data-section="profile-info"><i class="fas fa-user"></i> Profile Information</a></li>
                        <li><a href="#" class="nav-link" data-section="wishlist"><i class="fas fa-heart"></i> My Wishlist</a></li>
                        <li><a href="#" class="nav-link" data-section="notifications"><i class="fas fa-bell"></i> Notifications</a></li>
                        <li><a href="#" class="nav-link" data-section="settings"><i class="fas fa-cog"></i> Settings</a></li>
                        <li><a href="#" class="nav-link" data-section="privacy"><i class="fas fa-shield-alt"></i> Privacy & Security</a></li>
                    </ul>
                </div>
                <div class="profile-main">
                    <div class="profile-header">
                        <h1 id="section-title">Profile Information</h1>
                    </div>
                    <div class="profile-content">
                        <div id="profile-info" class="profile-section active">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="wishlistCount">0</div>
                                    <div class="stat-label">Wishlist Items</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="totalSavings">R0</div>
                                    <div class="stat-label">Total Savings</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="alertsCount">0</div>
                                    <div class="stat-label">Price Alerts</div>
                                </div>
                            </div>
                            <form id="profile-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstName">First Name</label>
                                        <input type="text" id="firstName" name="firstName" value="">
                                    </div>
                                    <div class="form-group">
                                        <label for="lastName">Last Name</label>
                                        <input type="text" id="lastName" name="lastName" value="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" value="">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn">Update Profile</button>
                                    <button type="button" class="btn btn-secondary">Cancel</button>
                                </div>
                            </form>
                        </div>
                        <div id="wishlist" class="profile-section">
                            <div class="wishlist-search-wrapper">
                                <div class="wishlist-search-container">
                                    <input type="text" id="wishlistSearch" placeholder="Search wishlist..." class="wishlist-search-input">
                                    <button id="clearWishlistSearch" class="clear-search-btn" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="wishlist-grid" id="wishlistGrid"></div>
                            <div id="empty-wishlist" class="empty-wishlist" style="display: none;">
                                <i class="far fa-heart"></i>
                                <p>Your wishlist is empty</p>
                                <p class="empty-wishlist-subtext">Add items to your wishlist by clicking the heart icon on products</p>
                            </div>
                        </div>
                        <div id="notifications" class="profile-section">
                            <div id="notificationsList"></div>
                        </div>
                        <div id="settings" class="profile-section">
                            <form id="settings-form">
                                <div class="form-group">
                                    <label for="emailNotifications">
                                        <input type="checkbox" id="emailNotifications" checked>
                                        Email notifications for price drops
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn">Save Settings</button>
                                </div>
                            </form>
                        </div>
                        <div id="privacy" class="profile-section">
                            <form id="privacy-form">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" name="currentPassword">
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" name="newPassword">
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm New Password</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn">Change Password</button>
                                </div>
                                <hr style="margin: 30px 0;">
                                <div class="form-group">
                                    <button type="button" class="btn btn-logout" id="logoutBtn">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                    <button type="button" class="btn" style="background: #dc3545;">Delete Account</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    
    <!-- Wishlist Modal -->
    <div id="wishlist-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-actions">
                    <a href="#" class="view-all-btn nav-link" data-section="wishlist">View All</a>
                    <button class="remove-all-btn" id="clear-wishlist-btn">Remove All</button>
                    <span class="close-modal">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <div id="wishlist-items" class="wishlist-grid">
                    <!-- Wishlist items will be populated here -->
                </div>
                <div id="modal-empty-wishlist" class="empty-wishlist" style="display: none;">
                    <i class="far fa-heart"></i>
                    <p>Your wishlist is empty</p>
                    <p class="empty-wishlist-subtext">Add items to your wishlist by clicking the heart icon on products</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Dialog -->
    <div id="confirmation-dialog" class="modal">
        <div class="modal-content confirmation-modal">
            <div class="confirmation-header">
                <h3 id="confirmation-title">Confirmation</h3>
            </div>
            <div class="confirmation-body">
                <p id="confirmation-message">Are you sure you want to proceed?</p>
            </div>
            <div class="confirmation-footer">
                <button id="confirmation-cancel" class="confirmation-btn cancel-btn">Cancel</button>
                <button id="confirmation-confirm" class="confirmation-btn confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About CompareHubPrices</h3>
                <ul>
                    <li><a href="#about">About Us</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Help & Support</h3>
                <ul>
                    <li><a href="#contact">Contact Us</a></li>
                    <li><a href="#faq">FAQs</a></li>
                    <li><a href="#privacy">Privacy Policy</a></li>
                    <li><a href="#terms">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="social-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                    <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
                </div>
                <div class="newsletter-section">
                    <h4>Get the Best Deals in Your Inbox</h4>
                    <form class="newsletter-form" onsubmit="subscribeNewsletter(event)">
                        <input type="email" placeholder="Enter your email address" required aria-label="Email address for newsletter">
                        <button type="submit"><i class="fas fa-paper-plane"></i> Subscribe</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 CompareHub Prices. All rights reserved.</p>
        </div>
    </footer>
<script>


document.addEventListener('DOMContentLoaded', async function() {
    // ---------- USER INFO HELPERS (Handles Cognito and Google users) ----------
    function getAttribute(userInfo, attrName) {
        const attrs = userInfo.Attributes || userInfo.UserAttributes || [];
        if (Array.isArray(attrs)) {
            const found = attrs.find(attr => attr.Name === attrName);
            if (found) return found.Value;
        }
        // Google user: direct property
        if (userInfo[attrName]) return userInfo[attrName];
        // Support your custom Google shape
        if (attrName === 'picture' && userInfo.avatar) return userInfo.avatar;
        if (attrName === 'picture' && userInfo.picture) return userInfo.picture;
        return '';
    }

    function getDisplayName(userInfo) {
        if (userInfo.name) return userInfo.name;
        if (userInfo.displayName) return userInfo.displayName;
        let firstName = getAttribute(userInfo, 'given_name');
        let lastName = getAttribute(userInfo, 'family_name');
        let name = getAttribute(userInfo, 'name');
        let email = getAttribute(userInfo, 'email');
        if (firstName) return firstName + (lastName ? ' ' + lastName : '');
        if (name) return name;
        if (email) return email.split('@')[0].replace(/[.\-_]/g, ' ').replace(/(^|\s)\S/g, l => l.toUpperCase());
        return userInfo.userId || userInfo.Username || '';
    }

    function getAvatarInitials(userInfo) {
        if (userInfo.avatar || userInfo.picture) return ""; // Show avatar photo if available
        const displayName = getDisplayName(userInfo);
        if (displayName) {
            const parts = displayName.split(' ');
            if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            return displayName[0].toUpperCase();
        }
        return 'U';
    }

    // Only require userInfo, not authToken, for session
    async function loadAndRenderProfile() {
        let userInfo = null;
        try {
            userInfo = JSON.parse(localStorage.getItem('userInfo'));
        } catch (e) { userInfo = null; }

        // If not logged in, redirect
        if (!userInfo) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = "login.html";
            return;
        }

        // Render profile
        const displayName = getDisplayName(userInfo);
        const email = getAttribute(userInfo, 'email');
        const firstName = getAttribute(userInfo, 'given_name');
        const lastName = getAttribute(userInfo, 'family_name');
        const avatarInitials = getAvatarInitials(userInfo);
        const avatarPic = getAttribute(userInfo, 'picture');

        // Avatar rendering (image if available, initials otherwise)
        const avatarDiv = document.getElementById('avatarInitials');
        avatarDiv.innerHTML = `
            ${avatarPic ? `<img src="${avatarPic}" alt="Avatar" class="avatar-img"/>` : avatarInitials}
            <button class="avatar-upload" title="Upload new avatar">
                <i class="fas fa-camera"></i>
            </button>
        `;

        document.getElementById('profileName').textContent = displayName;
        document.getElementById('profileEmail').textContent = email || '';

        // If Google user, don't allow editing name/email fields (they have no update endpoint)
        const googleUser = userInfo.provider === 'Google' || userInfo.sub || userInfo.userId;
        document.getElementById('firstName').value = firstName || (googleUser ? displayName.split(' ')[0] : '');
        document.getElementById('lastName').value = lastName || (googleUser ? (displayName.split(' ')[1] || '') : '');
        document.getElementById('email').value = email || '';

        document.getElementById('firstName').readOnly = !!googleUser;
        document.getElementById('lastName').readOnly = !!googleUser;
        document.getElementById('email').readOnly = true;

        // Hide password section for Google users
        if (googleUser) {
            document.getElementById('privacy-form').style.display = "none";
        } else {
            document.getElementById('privacy-form').style.display = "";
        }
    }

    // Dummy API Calls for updating profile (Cognito only)
    async function updateProfileName(firstName, lastName) {
        // Only update if not Google user
        let userInfo = null;
        try {
            userInfo = JSON.parse(localStorage.getItem('userInfo'));
        } catch (e) {}
        const googleUser = userInfo && (userInfo.provider === 'Google' || userInfo.sub || userInfo.userId);
        if (googleUser) {
            alert("Google users cannot update their name via this form.");
            return false;
        }

        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            alert("Session expired. Please log in again.");
            window.location.href = "login.html";
            return false;
        }
        // Validate: At least one name field must be non-empty
        if (!firstName && !lastName) {
            alert('Please enter at least a first or last name to update your profile.');
            return false;
        }
        // Build payload with only non-empty fields
        const payload = {};
        if (firstName) payload.given_name = firstName;
        if (lastName) payload.family_name = lastName;
        payload.name = [firstName, lastName].filter(Boolean).join(' ').trim();

        try {
            const resp = await fetch("https://w1yg1wc8cf.execute-api.af-south-1.amazonaws.com/prod/update-profile", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });
            let data = {};
            try { data = await resp.json(); } catch (e) {}
            if (!resp.ok) {
                throw new Error(data.error || "Failed to update profile name");
            }
            // Update local userInfo
            // You may want to re-fetch userInfo here from the server
            return true;
        } catch (err) {
            alert(err.message);
            return false;
        }
    }

    async function updatePassword(oldPassword, newPassword) {
        const authToken = localStorage.getItem('authToken');
        try {
            const resp = await fetch("https://w1yg1wc8cf.execute-api.af-south-1.amazonaws.com/prod/change-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    oldPassword,
                    newPassword
                })
            });
            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(data.error || "Failed to change password");
            }
            return true;
        } catch (err) {
            alert(err.message);
            return false;
        }
    }

    await loadAndRenderProfile();

    // Section navigation
    document.querySelectorAll('.profile-nav .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.profile-nav .nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            const section = this.getAttribute('data-section');
            document.querySelectorAll('.profile-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.getElementById('section-title').textContent = this.textContent.trim();
        });
    });

    // Logout (from privacy section)
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = "login.html";
        });
    }

    // --- Update name
    document.getElementById('profile-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const result = await updateProfileName(firstName, lastName);
        if(result) {
            await loadAndRenderProfile();
            alert('Profile updated!');
        }
    });

    // --- Update password
    document.getElementById('privacy-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const oldPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        if(newPassword !== confirmPassword) {
            alert("Passwords do not match!");
            return;
        }
        const result = await updatePassword(oldPassword, newPassword);
        if(result) {
            alert('Password changed!');
            // Optionally, clear form fields here:
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
    });

    // Dummy handler for settings form
    document.getElementById('settings-form').addEventListener('submit', function(e){
        e.preventDefault();
        alert('Settings saved! (Demo)');
    });
});
</script>
</body>
</html>

